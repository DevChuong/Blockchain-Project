<!DOCTYPE HTML>
<html>
	<head>
		<title>Adding Records</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<meta name="description" content="" />
		<meta name="keywords" content="" />
		<link rel="stylesheet" href="assets/css/main.css" />
		<script src="./node_modules/web3/dist/web3.min.js"></script>
		<link rel="stylesheet" href="./cssfiles/addrecord.css">
	</head>
	<body class="is-preload">

		<!-- Header -->
			<header id="header">
				<a class="logo" href="index.html">Blockchain ProJect</a>
				<div style="background-color: #00ff00; color: black;">
					<input type="text" id="Account_Address" disabled="" size="73" style="width: 670px;font-weight: 600;">
				</div>

				<nav>
					<a href="#menu">Menu</a>
				</nav>
			</header>

			<!-- Nav -->
				<nav id="menu">
					<ul class="links">
						<li><a href="index.html">Home</a></li>
						<li><a href="Authorise.html">Authorize</a></li>
						<li><a href="Unauthorize.html">Unauthorize</a></li>
						<li><a href="Add_Records.html">Add records</a></li>
						<li><a href="Look_Up.html">Look up info</a></li>
						<li><a href="Sign_Verify.html">Sign/Verify</a></li>
						<li><a href="Look_Up_Records.html">Employee records</a></li>
					</ul>
				</nav>

		<!-- Banner -->
			<section id="banner">
				<div class="inner">
					<h1>Block chain in health care</h1>
					<p >This website's used for authorizing/unauthorizing, adding records and searching information from the system
					It's also used for signing and verifying certificate.</p>
				</div>
				<video autoplay loop muted playsinline src="images/hospital.mp4"></video>
			</section>

		<!-- phần front end  -->
			<section class="wrapper">
				<div class="inner">
					<header class="special">
						<h2 style="color:black; font-weight:bold;">Add records</h2>
						<p style="color:black; font-weight:bold; font-size:25px;">Make sure you are using the right authorized account !</p>
					</header>
					<h3 style="color:black; font-weight:bold;">Employee information</h3>


			<!-- Add record form -->
					<form method="post" action="#">
						<div class="row gtr-uniform">
							<div class="col-6 col-12-xsmall">
								<input disabled="" readonly="" type="text" name="hos_add" id="hos_add" value="" placeholder="Hospital address" style="color:black; font-weight:bold;"/>
							</div>
							<div class="col-6 col-12-xsmall">
								<input type="text" name="emp_add" id="emp_add" value="" placeholder="Employee Address" style="color:black; font-weight:bold;"/>
							</div>

							<div class="col-6 col-12-xsmall">
								<input type="text" name="id_record" id="id_record" value="" placeholder="ID  record" style="color:black; font-weight:bold;" />
							</div>

							<div class="col-6 col-12-xsmall">
								<input type="text" name="certificate" id="certificate" value="" placeholder="Certificate" style="color:black; font-weight:bold;" />
							</div>

							<div class="col-6 col-12-xsmall">
								<a href="#" id="add_rec" class="button primary" style="color: Black; font-weight:bold; font-size: 20px; width: 170px;margin-left: 1130px;margin-bottom:40px;" onclick=addRecord()>Submit</a>
							</div>

						</div>
					</form>
	</section>
			<!-- Confirm table -->
			<section class = "record_confirmation">
				<div class="inner">
					<header class="special">
						<h2 style="color:black; margin-top: 70px; font-family: Lucida,Monaco, monospace;">Record Confirmation</h2>
					</header>

				<div class="confirm_table" style=" margin-top:auto;">
					<div class="row gtr-uniform">
							<div class="col-6 col-12-xsmall">
								<input disabled="" readonly="" type="text" name="hos_add" id="hos_add_con" value="" placeholder="Hospital address" style="color: Black; font-weight:bold;"/>
							</div>
							<div class="col-6 col-12-xsmall">
								<input disabled="" type="text" name="emp_add" id="emp_add_con" value="" placeholder="Employee Address" style="color: Black; font-weight:bold;"/>
							</div>
							<div class="col-6 col-12-xsmall">
								<input disabled="" type="text" name="hos_name" id="trainee_hos_name_con" value="" placeholder=" Trainee Hospital Name" style="color: Black; font-weight:bold;" />
							</div>

							<div class="col-6 col-12-xsmall">
								<input disabled="" type="text" name="emp_ID" id="emp_ID_con" value="" placeholder="Employee ID" style="color: Black; font-weight:bold;"/>
							</div>
							<div class="col-6 col-12-xsmall">
								<input disabled="" type="text" name="emp_name" id="emp_name_con" value="" placeholder="Employee name" style="color: Black; font-weight:bold;"/>
							</div>
							<div class="col-6 col-12-xsmall">
								<input disabled="" type="text" name="id_record" id="id_record_con" value="" placeholder="ID  record" style="color: Black; font-weight:bold;"/>
							</div>
							<div class="col-6 col-12-xsmall">
								<input disabled="" type="text" name="record_hashing" id="record_hashing_con" value="" placeholder="Record Hashing" style="color: Black; font-weight:bold;"/>
							</div>
							<div class="col-6 col-12-xsmall">
								<input disabled="" type="text" name="certificate" id="certificate_con" value="" placeholder="Certificate" style="color: Black; font-weight:bold;"/>
							</div>
							<div class="col-6 col-12-xsmall">
								<input disabled="" type="text" name="signature" id="signature_con" value="" placeholder="Signature" style="color: Black; font-weight:bold;"/>
							</div>
							<div class="col-6 col-12-xsmall">
								<button id="add_record"type="button" name="button" style="width: 375px; font-size: 20px; margin-left: 120px; font-family: Lucida,Monaco, monospace; color: black; background-color: cornsilk;">Add Record</button>
							</div>

					</div>

				</div>
			</section>


			<!-- phần frontend gọi api -->
			<br>
			<br>
			<br>



		<!-- Footer -->
			<footer id="footer">
				<div class="inner">
					<div class="content">
						<section>
							<h3>About the project</h3>
							<p>Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum..</p>
						</section>
						<section>
							<h4>Functions</h4>
							<ul class="alt">
								<li><a href="index.html">Home</a></li>
								<li><a href="auth_all.html">Authorize</a></li>
								<li><a href="unauth.html">Unauthorize</a></li>
								<li><a href="lookuppage.html">Look up info</a></li>
								<li><a href="signverifymessage.html">Sign/Verify</a></li>
								<li><a href="lookuprecords.html">Employee records</a></li>
							</ul>
						</section>
						<section>
							<h4>Team social media</h4>
							<ul class="plain">
								<li><a href="#"><i class="icon fa-twitter">&nbsp;</i>Twitter</a></li>
								<li><a href="#"><i class="icon fa-facebook">&nbsp;</i>Facebook</a></li>
								<li><a href="#"><i class="icon fa-instagram">&nbsp;</i>Instagram</a></li>
								<li><a href="#"><i class="icon fa-github">&nbsp;</i>Github</a></li>
							</ul>
						</section>
					</div>
					<div class="copyright">
						&copy; This is the blockchain project website.
					</div>
				</div>
			</footer>

		<!-- Scripts -->
			<script src="assets/js/jquery.min.js"></script>
			<script src="assets/js/browser.min.js"></script>
			<script src="assets/js/breakpoints.min.js"></script>
			<script src="assets/js/util.js"></script>
			<script src="assets/js/main.js"></script>


<script type="text/javascript">
	$(function(){
		$(".record_confirmation").hide();
	})
</script>

		<!-- Phần Add record  -->
			<script>
				function addRecord(){
						try {
							$(".wrapper").hide();
							var HospitalAddress = $("#hos_add").val();
							var TraineeAddress = $("#emp_add").val();
							var IDRecord = $("#id_record").val();
							var Certificate = $("#certificate").val();


							var addressCheck = web3.isAddress(TraineeAddress);
							if(addressCheck == true)
							{
								var traineeInfo = contract.See_Employee_Info(TraineeAddress, {from: account, gas: 3000000});
								console.log(traineeInfo);
								if(traineeInfo[0] != 0)
								{
									var TraineeID = traineeInfo[0];
									var TraineeName = traineeInfo[1];
									var TraineeHosName = traineeInfo[2];

									var RecordHashing = "";

									var messageHashed = web3.sha3(Certificate);
									var Signature = web3.eth.sign(account, messageHashed);


									var result = "";
									const proxyurl = "https://cors-anywhere.herokuapp.com/";

									//Need to change URL
									//http://8a69b0bd.ngrok.io/user/hash?Trainee_ID=2001&QR_Code=99700
									const url = "http://baf9eaa1.ngrok.io/user/hash?Trainee_ID=" + TraineeID + "&QR_Code=" + IDRecord;
								 // console.log(url);// site that doesn’t send Access-Control-*
									fetch(proxyurl + url) // https://cors-anywhere.herokuapp.com/https://example.com
									.then(response => response.json())
									.then(contents => {
									result = contents;
									if (result == 0)
									{
											alert("Error: Couldn't find hashing of your record !");
									}else
									{
										  RecordHashing = result;
										//	var Hashing = RecordHashing.valueOf();
											//alert(typeof(Hashing));

											$(".record_confirmation").show();
											$(".confirm_table").show();
											$("#hos_add_con").val(HospitalAddress);
											$("#emp_add_con").val(TraineeAddress);
											$("#trainee_hos_name_con").val(TraineeHosName);
											$("#emp_ID_con").val(TraineeID);
											$("#emp_name_con").val(TraineeName);
											$("#id_record_con").val(IDRecord);
											$("#record_hashing_con").val(RecordHashing);
											$("#certificate_con").val(Certificate);
											$("#signature_con").val(Signature);

											$("#add_record").click(function(){
												try{
													contract.Add_Records(HospitalAddress, TraineeAddress, TraineeID, TraineeName, TraineeHosName, IDRecord, RecordHashing, Certificate, Signature, {from: account, gas: 3000000});
													alert("Trainee Record is added successfully !");
												}catch{
													alert("Error: Fail to Add Trainee's Record !");
												}

											});

									}
								});



								}
							}else{
								alert("Error: Invalid Address !");
							}
						}catch
						{
							if(account != HospitalAddress) {
								alert("Error: the account does not match !");
							}else {
								alert("Please check your information again !");
							}
						}
					}


				function cache_clear() {
					window.location.reload(true);
				}


			</script>

			<script>
				$(function(){
					$("#Account_Address").val( "Index: " + index +" Account address: " + account);
					$("#hos_add").val(account);
				});
			</script>




		<!-- web3 -->
			<script>
				if(typeof web3 !== 'undefined'){
					web3 = new Web3(web3.currentProvider);
				} else {
					web3 = new Web3(new Web3.providers.HttpProvider("HTTP://127.0.0.1:8545"));
				}

				var index = 1;
				web3.eth.defaultAccount =  web3.eth.accounts[index];

				var account = web3.eth.defaultAccount

				var contract = web3.eth.contract([
	{
		"constant": false,
		"inputs": [
			{
				"name": "_HospitalAddress",
				"type": "address"
			},
			{
				"name": "_TraineeAddress",
				"type": "address"
			},
			{
				"name": "_TraineeID",
				"type": "uint256"
			},
			{
				"name": "_TraineeName",
				"type": "string"
			},
			{
				"name": "_TrHospitalName",
				"type": "string"
			}
		],
		"name": "Add_Employees",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "_HospitalAddress",
				"type": "address"
			},
			{
				"name": "_TraineeAddress",
				"type": "address"
			},
			{
				"name": "_TraineeID",
				"type": "uint256"
			},
			{
				"name": "_TraineeName",
				"type": "string"
			},
			{
				"name": "_TrHospitaName",
				"type": "string"
			},
			{
				"name": "_ID_Record",
				"type": "uint256"
			},
			{
				"name": "_Record_Hashing",
				"type": "string"
			},
			{
				"name": "_TraineeCertificate",
				"type": "string"
			},
			{
				"name": "_Signature",
				"type": "string"
			}
		],
		"name": "Add_Records",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "_HospitalAddress",
				"type": "address"
			},
			{
				"name": "_HospitalID",
				"type": "uint256"
			},
			{
				"name": "_HospitalName",
				"type": "string"
			}
		],
		"name": "Authorise_Hospital",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "_HospitalAddress",
				"type": "address"
			},
			{
				"name": "_TraineeAddress",
				"type": "address"
			},
			{
				"name": "_TraineeID",
				"type": "uint256"
			}
		],
		"name": "deleteEmployee",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "_HospitalAddress",
				"type": "address"
			},
			{
				"name": "_HospitalID",
				"type": "uint256"
			}
		],
		"name": "deleteHospital",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "_TraineeAddress",
				"type": "address"
			}
		],
		"name": "getListOfTraineesRecords",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"name": "_HospitalAddress",
				"type": "address"
			},
			{
				"indexed": false,
				"name": "_HospitalID",
				"type": "uint256"
			}
		],
		"name": "delete_Hospital",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"name": "_HospitalAddress",
				"type": "address"
			},
			{
				"indexed": false,
				"name": "_TraineeAddress",
				"type": "address"
			},
			{
				"indexed": false,
				"name": "_TraineeID",
				"type": "uint256"
			},
			{
				"indexed": false,
				"name": "_TraineeName",
				"type": "string"
			},
			{
				"indexed": false,
				"name": "_TrHospitaName",
				"type": "string"
			},
			{
				"indexed": false,
				"name": "_ID_Record",
				"type": "uint256"
			},
			{
				"indexed": false,
				"name": "_Record_Hashing",
				"type": "string"
			},
			{
				"indexed": false,
				"name": "_TraineeCertificate",
				"type": "string"
			},
			{
				"indexed": false,
				"name": "_Signature",
				"type": "string"
			}
		],
		"name": "add_Records",
		"type": "event"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "_NationalAuthority",
		"outputs": [
			{
				"name": "",
				"type": "address"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "_index",
				"type": "uint256"
			}
		],
		"name": "getFullRecords",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			},
			{
				"name": "",
				"type": "string"
			},
			{
				"name": "",
				"type": "string"
			},
			{
				"name": "",
				"type": "string"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "getListOfHospitals",
		"outputs": [
			{
				"components": [
					{
						"name": "_HospitalAddress",
						"type": "address"
					},
					{
						"name": "_HospitalID",
						"type": "uint256"
					},
					{
						"name": "_HospitalName",
						"type": "string"
					}
				],
				"name": "",
				"type": "tuple[]"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "getListOfTrainees",
		"outputs": [
			{
				"components": [
					{
						"name": "_TraineeAddress",
						"type": "address"
					},
					{
						"name": "_TraineeID",
						"type": "uint256"
					},
					{
						"name": "_TraineeName",
						"type": "string"
					},
					{
						"name": "_TrHospitaName",
						"type": "string"
					},
					{
						"name": "_ID_Record",
						"type": "uint256"
					},
					{
						"name": "_Record_Hashing",
						"type": "string"
					},
					{
						"name": "_TraineeCertificate",
						"type": "string"
					},
					{
						"name": "_Signature",
						"type": "string"
					}
				],
				"name": "",
				"type": "tuple[]"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "getListOfTraineesRecordsLength",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"name": "OfficialEmployees",
		"outputs": [
			{
				"name": "",
				"type": "address"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "Records",
		"outputs": [
			{
				"components": [
					{
						"name": "_TraineeAddress",
						"type": "address"
					},
					{
						"name": "_TraineeID",
						"type": "uint256"
					},
					{
						"name": "_TraineeName",
						"type": "string"
					},
					{
						"name": "_TrHospitaName",
						"type": "string"
					},
					{
						"name": "_ID_Record",
						"type": "uint256"
					},
					{
						"name": "_Record_Hashing",
						"type": "string"
					},
					{
						"name": "_TraineeCertificate",
						"type": "string"
					},
					{
						"name": "_Signature",
						"type": "string"
					}
				],
				"name": "",
				"type": "tuple[]"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "hash",
				"type": "bytes32"
			},
			{
				"name": "sig",
				"type": "bytes"
			}
		],
		"name": "recoverSigner",
		"outputs": [
			{
				"name": "",
				"type": "address"
			}
		],
		"payable": false,
		"stateMutability": "pure",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "_HospitalAddress",
				"type": "address"
			}
		],
		"name": "See_Authorised_Hospital",
		"outputs": [
			{
				"name": "",
				"type": "address"
			},
			{
				"name": "",
				"type": "uint256"
			},
			{
				"name": "",
				"type": "string"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "_TraineeAddress",
				"type": "address"
			}
		],
		"name": "See_Employee_Info",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			},
			{
				"name": "",
				"type": "string"
			},
			{
				"name": "",
				"type": "string"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "_TraineeAddress",
				"type": "address"
			}
		],
		"name": "See_Employee_Latest_Records",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			},
			{
				"name": "",
				"type": "string"
			},
			{
				"name": "",
				"type": "string"
			},
			{
				"name": "",
				"type": "uint256"
			},
			{
				"name": "",
				"type": "string"
			},
			{
				"name": "",
				"type": "string"
			},
			{
				"name": "",
				"type": "string"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	}
]).at('0x023403ab74f409120836426281a260f198e7d6fa');

			</script>




	</body>
</html>
